/*
  Garlic.js allows you to automatically persist your forms' text field values locally,
  until the form is submitted. This way, your users don't lose any precious data if they
  accidentally close their tab or browser.

  author: Guillaume Potier - @guillaumepotier
*/

!function(a){"use strict";var b=function(){this.defined="undefined"!=typeof localStorage};b.prototype={constructor:b,get:function(a,b){return localStorage.getItem(a)?localStorage.getItem(a):b!==void 0?b:null},has:function(a){return localStorage.getItem(a)?!0:!1},set:function(a,b,c){return"string"==typeof b&&(""===b?this.destroy(a):localStorage.setItem(a,b)),"function"==typeof c?c():!0},destroy:function(a,b){return localStorage.removeItem(a),"function"==typeof b?b():!0},clean:function(a){for(var b=localStorage.length-1;b>=0;b--)Array.indexOf===void 0&&-1!==localStorage.key(b).indexOf("garlic:")&&localStorage.removeItem(localStorage.key(b));return"function"==typeof a?a():!0},clear:function(a){return localStorage.clear(),"function"==typeof a?a():!0}};var c=function(a,b,c){this.init("garlic",a,b,c)};c.prototype={constructor:c,init:function(b,c,d,e){this.type=b,this.$element=a(c),this.options=this.getOptions(e),this.storage=d,this.path=this.options.getPath(this.$element)||this.getPath(),this.parentForm=this.$element.closest("form"),this.$element.addClass("garlic-auto-save"),this.expiresFlag=this.options.expires?(this.$element.data("expires")?this.path:this.getPath(this.parentForm))+"_flag":!1,this.$element.on(this.options.events.join("."+this.type+" "),!1,a.proxy(this.persist,this)),this.options.destroy&&a(this.parentForm).on("submit reset",!1,a.proxy(this.destroy,this)),this.retrieve()},getOptions:function(b){return a.extend({},a.fn[this.type].defaults,b,this.$element.data())},persist:function(){this.val!==this.getVal()&&(this.val=this.getVal(),this.options.expires&&this.storage.set(this.expiresFlag,""+((new Date).getTime()+1e3*this.options.expires)),this.storage.set(this.path,this.getVal()))},getVal:function(){return this.$element.is("input[type=checkbox]")?this.$element.attr("checked")?"checked":"unchecked":this.$element.val()},retrieve:function(){if(this.storage.has(this.path)){if(this.options.expires){var a=(new Date).getTime();if(""+a>this.storage.get(this.expiresFlag))return this.storage.destroy(this.path),void 0;this.$element.attr("expires-in",Math.floor((parseInt(this.storage.get(this.expiresFlag))-a)/1e3))}var b=this.storage.get(this.path);return this.options.conflictManager.enabled&&this.detectConflict()?this.conflictManager():this.$element.is("input[type=radio], input[type=checkbox]")?"checked"===b||this.$element.val()===b?this.$element.attr("checked",!0):("unchecked"===b&&this.$element.attr("checked",!1),void 0):(this.$element.val(b),this.options.onRetrieve(this.$element,b),void 0)}},detectConflict:function(){var b=this;if(this.$element.is("input[type=checkbox], input[type=radio]"))return!1;if(this.$element.val()&&this.storage.get(this.path)!==this.$element.val()){if(this.$element.is("select")){var c=!1;return this.$element.find("option").each(function(){return 0!==a(this).index()&&a(this).attr("selected")&&a(this).val()!==b.storage.get(this.path)?(c=!0,void 0):void 0}),c}return!0}return!1},conflictManager:function(){return"function"!=typeof this.options.conflictManager.onConflictDetected||this.options.conflictManager.onConflictDetected(this.$element,this.storage.get(this.path))?(this.options.conflictManager.garlicPriority?(this.$element.data("swap-data",this.$element.val()),this.$element.data("swap-state","garlic"),this.$element.val(this.storage.get(this.path))):(this.$element.data("swap-data",this.storage.get(this.path)),this.$element.data("swap-state","default")),this.swapHandler(),this.$element.addClass("garlic-conflict-detected"),this.$element.closest("input[type=submit]").attr("disabled",!0),void 0):!1},swapHandler:function(){var b=a(this.options.conflictManager.template);this.$element.after(b.text(this.options.conflictManager.message)),b.on("click",!1,a.proxy(this.swap,this))},swap:function(){var b=this.$element.data("swap-data");this.$element.data("swap-state","garlic"===this.$element.data("swap-state")?"default":"garlic"),this.$element.data("swap-data",this.$element.val()),a(this.$element).val(b)},destroy:function(){this.storage.destroy(this.path)},remove:function(){return this.remove(),this.$element.is("input[type=radio], input[type=checkbox]")?(a(this.$element).attr("checked",!1),void 0):(this.$element.val(""),void 0)},getPath:function(b){if(b===void 0&&(b=this.$element),this.options.getPath(b))return this.options.getPath(b);if(1!=b.length)return!1;for(var c="",d=b.is("input[type=checkbox]"),e=b;e.length;){var f=e[0],g=f.nodeName;if(!g)break;g=g.toLowerCase();var h=e.parent(),i=h.children(g);if(a(f).is("form, input, select, textarea")||d){if(g+=a(f).attr("name")?"."+a(f).attr("name"):"",i.length>1&&!a(f).is("input[type=radio]")&&(g+=":eq("+i.index(f)+")"),c=g+(c?">"+c:""),"form"==f.nodeName.toLowerCase())break;e=h}else e=h}return"garlic:"+document.domain+(this.options.domain?"*":window.location.pathname)+">"+c},getStorage:function(){return this.storage}},a.fn.garlic=function(d,e){function i(b){var e=a(b),h=e.data("garlic"),i=a.extend({},f,e.data());if((void 0===i.storage||i.storage)&&"password"!==a(b).attr("type"))return h||e.data("garlic",h=new c(b,g,i)),"string"==typeof d&&"function"==typeof h[d]?h[d]():void 0}var f=a.extend(!0,{},a.fn.garlic.defaults,d,this.data()),g=new b,h=!1;return g.defined?(this.each(function(){a(this).is("form")?a(this).find(f.inputs).each(function(){h=i(a(this))}):a(this).is(f.inputs)&&(h=i(a(this)))}),"function"==typeof e?e():h):!1},a.fn.garlic.Constructor=c,a.fn.garlic.defaults={destroy:!0,inputs:"input, textarea, select",events:["DOMAttrModified","textInput","input","change","click","keypress","paste","focus"],domain:!1,expires:!1,conflictManager:{enabled:!1,garlicPriority:!0,template:'<span class="garlic-swap"></span>',message:"This is your saved data. Click here to see default one",onConflictDetected:function(){return!0}},getPath:function(){},onRetrieve:function(){}},a(window).on("load",function(){a('[data-persist="garlic"]').each(function(){a(this).garlic()})})}(window.jQuery||window.Zepto);